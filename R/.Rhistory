y2019<-crime_YTD[ (year=='2019')&(Beat=='18F30')
,.(FREQ=sum(OffenseCount)),by=c("Premise")]
y2019$prop<-y2019$FREQ/sum(y2019$FREQ)
View(y2019)
View(y2019)
#18F30
##-Violent
crimes_filtered<-multi_year[ (NIBRSDescription %chin% violent_crimes)
&(Beat=='18F30')]%>%
.[,NIBRSDescription:='Violent']
NIBRS_Trend(indata=crimes_filtered,'Violent')
NIBRS_YTD(indata=crimes_filtered,'Violent')
crime_YTD<-crimes_filtered[ ( RMSOccurrenceDate>=glue('{bas_yr}-01-01')
&RMSOccurrenceDate<=base_end_dt)
|( RMSOccurrenceDate>=glue('{pri_yr}-01-01')
&RMSOccurrenceDate<=pri_end_dt)
|( RMSOccurrenceDate>=glue('{cur_yr}-01-01')
&RMSOccurrenceDate<=cur_end_dt),]
y2019<-crime_YTD[ (year=='2019')&(Beat=='18F30')
,.(FREQ=sum(OffenseCount)),by=c("Premise")]
y2019$prop<-y2019$FREQ/sum(y2019$FREQ)
y2019$year<-'2019'
y2022<-crime_YTD[ (year=='2022')&(Beat=='18F30')
,.(FREQ=sum(OffenseCount)),by=c("Premise")]
y2022$prop<-y2022$FREQ/sum(y2022$FREQ)
y2022$year<-'2022'
y2023<-crime_YTD[ (year=='2023')&(Beat=='18F30')
,.(FREQ=sum(OffenseCount)),by=c("Premise")]
y2023$prop<-y2023$FREQ/sum(y2023$FREQ)
y2023$year<-'2023'
View(y2019)
View(y2019)
NIBRS_YTD(indata=crimes_filtered,'Violent')
data_concat <- rbindlist(list(y2019,y2022,y2023))
View(data_concat)
View(data_concat)
ggplot( data=data_concat
,aes( y=OffenseCount
,x=Premise
,fill=year))+
geom_bar( position="dodge"
,stat="identity")+
ggtitle(glue("Year-To-Date"))+
theme_economist()+
scale_fill_manual(values=c('darkblue', 'darkgreen', 'darkred'))
View(data_concat)
View(data_concat)
View(y2019)
View(y2019)
View(data_concat)
View(data_concat)
ggplot( data=data_concat
,aes( y=FREQ
,x=Premise
,fill=year))+
geom_bar( position="dodge"
,stat="identity")+
ggtitle(glue("Year-To-Date"))+
theme_economist()+
scale_fill_manual(values=c('darkblue', 'darkgreen', 'darkred'))
ggplot( data=data_concat
,aes( y=FREQ
,x=Premise
,fill=year))+
geom_col( position="dodge"
,stat="identity")+
ggtitle(glue("Year-To-Date"))+
theme_economist()+
scale_fill_manual(values=c('darkblue', 'darkgreen', 'darkred'))
ggplot( data=data_concat
,aes( y=FREQ
,x=Premise
,fill=year))+
geom_bar( position="dodge"
,stat="identity")+
ggtitle(glue("Year-To-Date"))+
theme_economist()+
scale_fill_manual(values=c('darkblue', 'darkgreen', 'darkred'))
ggplot( data=data_concat
,aes( y=FREQ
,x=Premise
,fill=year))+
geom_bar( position="dodge"
,stat="identity")+
coord_flip()+
ggtitle(glue("Year-To-Date"))+
theme_economist()+
scale_fill_manual(values=c('darkblue', 'darkgreen', 'darkred'))
View(data_concat)
View(data_concat)
View(data_concat)
View(data_concat)
ggplot( data=data_concat
,aes( y=FREQ
,x=Premise
,fill=year))+
geom_bar( position="dodge"
,stat="identity")+
coord_flip()+
ggtitle(glue("Beat 18F30 Jan-July Violent Crime Incidents"))+
theme_economist()+
scale_fill_manual(values=c('darkblue', 'darkgreen', 'darkred'))
ggplot( data=data_concat
,aes( y=FREQ
,x=Premise
,fill=year))+
geom_bar( position="dodge"
,stat="identity")+
coord_flip()+
ggtitle(glue("Beat 18F30\n Jan-July Violent Crime Incidents"))+
theme_economist()+
scale_fill_manual(values=c('darkblue', 'darkgreen', 'darkred'))
ggplot( data=data_concat
,aes( y=FREQ
,x=Premise
,fill=year))+
geom_bar( position="dodge"
,stat="identity")+
coord_flip()+
ggtitle(glue("Beat 18F30\n Jan-Jun Violent Crime Incidents"))+
theme_economist()+
scale_fill_manual(values=c('darkblue', 'darkgreen', 'darkred'))
#18F30
##-Violent
crimes_filtered<-multi_year[ (NIBRSDescription %chin% violent_crimes)
&(Beat=='18F30')]%>%
.[,NIBRSDescription:='Violent']
NIBRS_Trend(indata=crimes_filtered,'Violent')
NIBRS_YTD(indata=crimes_filtered,'Violent')
NIBRS_Trend(indata=crimes_filtered,'Violent')
NIBRS_YTD(indata=crimes_filtered,'Beat: 18F30\nViolent')
##-Violent
crimes_filtered<-multi_year[ (NIBRSDescription %chin% violent_crimes)
&(Beat=='18F30')]%>%
.[,NIBRSDescription:='Violent']
NIBRS_Trend(indata=crimes_filtered,'Violent')
NIBRS_YTD(indata=crimes_filtered,'Beat: 18F30\nViolent')
crime_YTD<-crimes_filtered[ ( RMSOccurrenceDate>=glue('{bas_yr}-01-01')
&RMSOccurrenceDate<=base_end_dt)
|( RMSOccurrenceDate>=glue('{pri_yr}-01-01')
&RMSOccurrenceDate<=pri_end_dt)
|( RMSOccurrenceDate>=glue('{cur_yr}-01-01')
&RMSOccurrenceDate<=cur_end_dt),]
y2019<-crime_YTD[ (year=='2019')&(Beat=='18F30')
,.(FREQ=sum(OffenseCount)),by=c("Premise")]
y2019$prop<-y2019$FREQ/sum(y2019$FREQ)
y2019$year<-'2019'
y2022<-crime_YTD[ (year=='2022')&(Beat=='18F30')
,.(FREQ=sum(OffenseCount)),by=c("Premise")]
y2022$prop<-y2022$FREQ/sum(y2022$FREQ)
y2022$year<-'2022'
y2023<-crime_YTD[ (year=='2023')&(Beat=='18F30')
,.(FREQ=sum(OffenseCount)),by=c("Premise")]
y2023$prop<-y2023$FREQ/sum(y2023$FREQ)
y2023$year<-'2023'
data_concat <- rbindlist(list(y2019,y2022,y2023))
ggplot( data=data_concat
,aes( y=FREQ
,x=Premise
,fill=year))+
geom_bar( position="dodge"
,stat="identity")+
coord_flip()+
ggtitle(glue("Beat 18F30\n Jan-Jun Violent Crime Incidents"))+
theme_economist()+
scale_fill_manual(values=c('darkblue', 'darkgreen', 'darkred'))
ggplot( data=plot_pre
,aes( y=prop
,x=prem_oth
,fill=cat))+
geom_bar( position="dodge"
,stat="identity")+
ggtitle(glue("Year-To-Date"))+
theme_economist()+
scale_fill_manual(values=c('darkblue', 'darkgreen', 'darkred'))
chisq.test( prem_chi_pre$Freq
,p=prem_chi_pre$prop_exp)
library("readxl")
library("glue")
library("tidyverse")
library("data.table")
library("zoo")
library("ggplot2")
library("ggthemes")
library("leaflet")
library('sf')
library('dplyr')
library('htmlwidgets')
setwd('C:/Users/chris/Documents/GitHub/HoustonCrimeDataAnalysis/R')
source('NIBRS_Trendx.R')
source('YTD_NIBRS.R')
source('GEOPLOT.R')
sf_use_s2(FALSE)
where_the_data_is<-'C:/Users/chris/Documents/Random_Nextdoor/My_Crime_Analysis - 05.04.23/Group/Data/HPD_NIBRS/'
support_dir<-'C:/Users/chris/Documents/GitHub/HoustonCrimeDataAnalysis/DATA/Support/'
districts<-st_read(glue("{support_dir}COH_ADMINISTRATIVE_BOUNDARY_-_MIL.geojson"))%>%
filter(!is.na(DISTRICT) )
beats<-st_read(glue("{support_dir}COH_POLICE_BEATS.geojson"))
bydim<-'Overall'
group_dims<-c('NIBRSDescription',bydim)
violent_crimes<-c('Aggravated Assault'
,'Forcible rape'
,'Robbery'
,'Murder, non-negligent')
baseline<-read_excel(glue('{where_the_data_is}2019_NIBRSPublicView.Jan1-Dec31.xlsx'))%>%
rename( OffenseCount=`Offense\r\nCount`
,RMSOccurrenceDate=`Occurrence\r\nDate`
,ZIPCode=`ZIP Code`
,StreetType=`Street\r\nType`
,RMSOccurrenceHour=`Occurrence\r\nHour`
,NIBRSClass=`NIBRS\r\nClass`
,StreetNo=`Block Range`)
baseline$MapLongitude<-NA
baseline$MapLatitude<-NA
min(baseline$RMSOccurrenceDate)
max(baseline$RMSOccurrenceDate)
year1<-read_excel(glue('{where_the_data_is}NIBRSPublicView.Jan1-Dec31-2020.xlsx'))%>%
rename( OffenseCount=`Offense\r\nCount`
,RMSOccurrenceDate=`Occurrence\r\nDate`
,ZIPCode=`ZIP Code`
,StreetType=`Street\r\nType`
,RMSOccurrenceHour=`Occurrence\r\nHour`
,NIBRSClass=`NIBRS\r\nClass`
,StreetNo=`Block Range`)
year1$MapLongitude<-NA
year1$MapLatitude<-NA
min(year1$RMSOccurrenceDate)
max(year1$RMSOccurrenceDate)
year2<-read_excel(glue('{where_the_data_is}NIBRSPublicViewDec21.xlsx'))
year2$MapLongitude<-NA
year2$MapLatitude<-NA
min(year2$RMSOccurrenceDate)
max(year2$RMSOccurrenceDate)
year3<-read_excel(glue('{where_the_data_is}NIBRSPublicViewDec22.xlsx'))
min(year3$RMSOccurrenceDate)
max(year3$RMSOccurrenceDate)
year4<-read_excel(glue('{where_the_data_is}NIBRSPublicViewJun23.xlsx'))
min(year4$RMSOccurrenceDate)
max(year4$RMSOccurrenceDate)
multi_year<-rbind(baseline,year1,year2,year3,year4)%>%
mutate(year_mon=floor_date(RMSOccurrenceDate,'month'))
multi_year$year<-year(multi_year$RMSOccurrenceDate)
multi_year$Overall<-'OverAll'
all_desc<-multi_year%>%group_by(NIBRSDescription)%>%summarize(Freq=sum(OffenseCount))
all_prem<-multi_year%>%group_by(Premise)%>%summarize(Freq=sum(OffenseCount))
setDT(multi_year)
to_dt_month<-'06'
YTD_VOLUMES<-multi_year[ (NIBRSDescription %chin% violent_crimes),]%>%
.[ ( RMSOccurrenceDate>=glue('2019-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2019))
|( RMSOccurrenceDate>=glue('2020-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2020))
|( RMSOccurrenceDate>=glue('2021-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2021))
|( RMSOccurrenceDate>=glue('2022-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2022))
|( RMSOccurrenceDate>=glue('2023-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2023)),]
ETL_VALIDATE<-function(){
qa_year_mon<-multi_year%>%
group_by(year_mon)%>%
summarize(Row_Count=n())%>%
filter()
qa_year_mon$year_mon<-as.Date(qa_year_mon$year_mon)
str(qa_year_mon)
ggplot( data=qa_year_mon
,aes( x=year_mon
,y=Row_Count))+
geom_bar(stat="identity")+
scale_x_date( breaks = date_breaks("months")
,labels = date_format("%b-%Y")
,expand = c(.01, .01))+
theme(axis.text.x = element_text( angle = 90
,vjust = 0.5
,hjust=1))+
#  Labelling as desired
labs(
title = "Row-Counts By Year-Month"
#,subtitle = "SUB"
#,caption = "Caption"
)
qa_year<-multi_year%>%
group_by(year)%>%
summarize(Row_Count=n())
ggplot( data=qa_year
,aes( x=year
,y=Row_Count))+
geom_bar(stat="identity")
qa_year_by_year_mon<-multi_year%>%group_by(year_mon,year)%>%summarize(freq=n())
to_dt_month<-'06'
YTD_VOLUMES<-multi_year[ (NIBRSDescription %chin% violent_crimes),]%>%
.[ ( RMSOccurrenceDate>=glue('2019-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2019))
|( RMSOccurrenceDate>=glue('2020-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2020))
|( RMSOccurrenceDate>=glue('2021-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2021))
|( RMSOccurrenceDate>=glue('2022-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2022))
|( RMSOccurrenceDate>=glue('2023-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2023)),]
year_vol<-YTD_VOLUMES%>%group_by(year)%>%summarize(freq=n())
ggplot( data=year_vol
,aes( x=year
,y=freq))+
geom_bar(stat="identity")
}
## Overall Violent
crimes_filtered<-multi_year[ (NIBRSDescription %chin% violent_crimes)
&(RMSOccurrenceDate>='2023-01-01')
&(RMSOccurrenceDate<='2023-06-30')]
beats_agg<-crimes_filtered[,.(N=sum(OffenseCount)),by=c('Beat')]
pre<-setDT(crimes_filtered)
# Recode Premise
pre[,prem_oth:=ifelse( Premise %in% c( 'Residence, Home (Includes Apartment)'
,'Parking Lot, Garage'
,'Highway, Road, Street, Alley')
,Premise
,'Other')]
beats_n<-setDT(beats_agg[,c('Beat','N')])
#NIBRS Premise Recat
beats_prem<-pre[,.(Freq=sum(OffenseCount))
,by=c('prem_oth','Beat')]
beat_fin<-beats_n[ beats_prem
,on=.(Beat)]
beat_fin$prop<-beat_fin$Freq/beat_fin$N
prem_xtab<-dcast( beat_fin
,Beat~prem_oth
,value.var = c("prop"))
## Overall Houston Recat Premise
prem_ovr<-pre[,.(pop_freq=sum(OffenseCount))
,by=c('prem_oth')]
prem_ovr$prop_exp<-prem_ovr$pop_freq/sum(prem_ovr$pop_freq)
prem_chi_pre<-prem_ovr[ beat_fin[Beat=='18F30']
,on=.(prem_oth)]
exp_tab<-prem_chi_pre[,.(prem_oth,prop=prop_exp,cat='EXP')]
obs_tab<-prem_chi_pre[,.(prem_oth,prop=prop,cat='OBS')]
plot_pre<-rbindlist(list( exp_tab
,obs_tab))
#18F30
##-Violent
crimes_filtered<-multi_year[ (NIBRSDescription %chin% violent_crimes)
&(Beat=='18F30')]%>%
.[,NIBRSDescription:='Violent']
NIBRS_Trend(indata=crimes_filtered,'Violent')
NIBRS_YTD(indata=crimes_filtered,'Beat: 18F30\nViolent')
crime_YTD<-crimes_filtered[ ( RMSOccurrenceDate>=glue('{bas_yr}-01-01')
&RMSOccurrenceDate<=base_end_dt)
|( RMSOccurrenceDate>=glue('{pri_yr}-01-01')
&RMSOccurrenceDate<=pri_end_dt)
|( RMSOccurrenceDate>=glue('{cur_yr}-01-01')
&RMSOccurrenceDate<=cur_end_dt),]
bas_yr='2019'
pri_yr='2022'
cur_yr='2023'
latest_mon='06'
## Overall Violent
crimes_filtered<-multi_year[ (NIBRSDescription %chin% violent_crimes)
&(RMSOccurrenceDate>='2023-01-01')
&(RMSOccurrenceDate<='2023-06-30')]
beats_agg<-crimes_filtered[,.(N=sum(OffenseCount)),by=c('Beat')]
pre<-setDT(crimes_filtered)
# Recode Premise
pre[,prem_oth:=ifelse( Premise %in% c( 'Residence, Home (Includes Apartment)'
,'Parking Lot, Garage'
,'Highway, Road, Street, Alley')
,Premise
,'Other')]
beats_n<-setDT(beats_agg[,c('Beat','N')])
#NIBRS Premise Recat
beats_prem<-pre[,.(Freq=sum(OffenseCount))
,by=c('prem_oth','Beat')]
beat_fin<-beats_n[ beats_prem
,on=.(Beat)]
beat_fin$prop<-beat_fin$Freq/beat_fin$N
ggplot( data=beat_fin
,aes( y=prop
,x=prem_oth
,group=Beat))+
geom_bar( position="dodge"
,stat="identity")+facet_wrap(~Beat)
prem_xtab<-dcast( beat_fin
,Beat~prem_oth
,value.var = c("prop"))
## Overall Houston Recat Premise
prem_ovr<-pre[,.(pop_freq=sum(OffenseCount))
,by=c('prem_oth')]
prem_ovr$prop_exp<-prem_ovr$pop_freq/sum(prem_ovr$pop_freq)
prem_chi_pre<-prem_ovr[ beat_fin[Beat=='18F30']
,on=.(prem_oth)]
exp_tab<-prem_chi_pre[,.(prem_oth,prop=prop_exp,cat='EXP')]
obs_tab<-prem_chi_pre[,.(prem_oth,prop=prop,cat='OBS')]
plot_pre<-rbindlist(list( exp_tab
,obs_tab))
ggplot( data=plot_pre
,aes( y=prop
,x=prem_oth
,fill=cat))+
geom_bar( position="dodge"
,stat="identity")+
ggtitle(glue("Year-To-Date"))+
theme_economist()+
scale_fill_manual(values=c('darkblue', 'darkgreen', 'darkred'))
chisq.test( prem_chi_pre$Freq
,p=prem_chi_pre$prop_exp)
#18F30
##-Violent
crimes_filtered<-multi_year[ (NIBRSDescription %chin% violent_crimes)
&(Beat=='18F30')]%>%
.[,NIBRSDescription:='Violent']
NIBRS_Trend(indata=crimes_filtered,'Violent')
NIBRS_YTD(indata=crimes_filtered,'Beat: 18F30\nViolent')
crime_YTD<-crimes_filtered[ ( RMSOccurrenceDate>=glue('{bas_yr}-01-01')
&RMSOccurrenceDate<=base_end_dt)
|( RMSOccurrenceDate>=glue('{pri_yr}-01-01')
&RMSOccurrenceDate<=pri_end_dt)
|( RMSOccurrenceDate>=glue('{cur_yr}-01-01')
&RMSOccurrenceDate<=cur_end_dt),]
bas_yr='2019'
pri_yr='2022'
cur_yr='2023'
latest_mon='06'
base_end_dt<-eom(latest_mon,bas_yr)
pri_end_dt<-eom(latest_mon,pri_yr)
cur_end_dt<-eom(latest_mon,cur_yr)
## Overall Violent
crimes_filtered<-multi_year[ (NIBRSDescription %chin% violent_crimes)
&(RMSOccurrenceDate>='2023-01-01')
&(RMSOccurrenceDate<='2023-06-30')]
beats_agg<-crimes_filtered[,.(N=sum(OffenseCount)),by=c('Beat')]
pre<-setDT(crimes_filtered)
# Recode Premise
pre[,prem_oth:=ifelse( Premise %in% c( 'Residence, Home (Includes Apartment)'
,'Parking Lot, Garage'
,'Highway, Road, Street, Alley')
,Premise
,'Other')]
beats_n<-setDT(beats_agg[,c('Beat','N')])
#NIBRS Premise Recat
beats_prem<-pre[,.(Freq=sum(OffenseCount))
,by=c('prem_oth','Beat')]
beat_fin<-beats_n[ beats_prem
,on=.(Beat)]
beat_fin$prop<-beat_fin$Freq/beat_fin$N
ggplot( data=beat_fin
,aes( y=prop
,x=prem_oth
,group=Beat))+
geom_bar( position="dodge"
,stat="identity")+facet_wrap(~Beat)
prem_xtab<-dcast( beat_fin
,Beat~prem_oth
,value.var = c("prop"))
## Overall Houston Recat Premise
prem_ovr<-pre[,.(pop_freq=sum(OffenseCount))
,by=c('prem_oth')]
prem_ovr$prop_exp<-prem_ovr$pop_freq/sum(prem_ovr$pop_freq)
prem_chi_pre<-prem_ovr[ beat_fin[Beat=='18F30']
,on=.(prem_oth)]
exp_tab<-prem_chi_pre[,.(prem_oth,prop=prop_exp,cat='EXP')]
obs_tab<-prem_chi_pre[,.(prem_oth,prop=prop,cat='OBS')]
plot_pre<-rbindlist(list( exp_tab
,obs_tab))
ggplot( data=plot_pre
,aes( y=prop
,x=prem_oth
,fill=cat))+
geom_bar( position="dodge"
,stat="identity")+
ggtitle(glue("Year-To-Date"))+
theme_economist()+
scale_fill_manual(values=c('darkblue', 'darkgreen', 'darkred'))
chisq.test( prem_chi_pre$Freq
,p=prem_chi_pre$prop_exp)
#18F30
##-Violent
crimes_filtered<-multi_year[ (NIBRSDescription %chin% violent_crimes)
&(Beat=='18F30')]%>%
.[,NIBRSDescription:='Violent']
NIBRS_Trend(indata=crimes_filtered,'Violent')
NIBRS_YTD(indata=crimes_filtered,'Beat: 18F30\nViolent')
crime_YTD<-crimes_filtered[ ( RMSOccurrenceDate>=glue('{bas_yr}-01-01')
&RMSOccurrenceDate<=base_end_dt)
|( RMSOccurrenceDate>=glue('{pri_yr}-01-01')
&RMSOccurrenceDate<=pri_end_dt)
|( RMSOccurrenceDate>=glue('{cur_yr}-01-01')
&RMSOccurrenceDate<=cur_end_dt),]
y2019<-crime_YTD[ (year=='2019')&(Beat=='18F30')
,.(FREQ=sum(OffenseCount)),by=c("Premise")]
y2019$prop<-y2019$FREQ/sum(y2019$FREQ)
y2019$year<-'2019'
y2022<-crime_YTD[ (year=='2022')&(Beat=='18F30')
,.(FREQ=sum(OffenseCount)),by=c("Premise")]
y2022$prop<-y2022$FREQ/sum(y2022$FREQ)
y2022$year<-'2022'
y2023<-crime_YTD[ (year=='2023')&(Beat=='18F30')
,.(FREQ=sum(OffenseCount)),by=c("Premise")]
y2023$prop<-y2023$FREQ/sum(y2023$FREQ)
y2023$year<-'2023'
data_concat <- rbindlist(list(y2019,y2022,y2023))
ggplot( data=data_concat
,aes( y=FREQ
,x=Premise
,fill=year))+
geom_bar( position="dodge"
,stat="identity")+
coord_flip()+
ggtitle(glue("Beat 18F30\n Jan-Jun Violent Crime Incidents"))+
theme_economist()+
scale_fill_manual(values=c('darkblue', 'darkgreen', 'darkred'))
View(data_concat)
View(data_concat)
