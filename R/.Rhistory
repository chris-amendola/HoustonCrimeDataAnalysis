addLayersControl(
baseGroups = c("OSM (default)","World StreetMap", "World Imagery"),
options = layersControlOptions(collapsed = FALSE))%>%
addPolygons(data = final,
fillColor = ~pal(final$diff_prior),
fillOpacity = 0.7,
weight = 1.0,
smoothFactor = 0.2,
popup = ~popup) %>%
addLegend(pal = pal,
values = final$diff_prior,
position = "bottomright",
title = "YTD Changes in Violent Crime Counts")
data_pre<-multi_year[  (NIBRSDescription %chin% violent_crimes)
&(RMSOccurrenceDate>='2023-06-01')
,]%>%
.[ (!is.na(MapLongitude))
|(!is.na(MapLatitude))]%>%
st_as_sf( coords=c("MapLongitude","MapLatitude")
,crs=4326
,remove=FALSE)
datax<-st_join( data_pre
,districts
,join = st_within)
geo_plot<-function(data=data){
pal <- colorFactor(
palette = c('orange', 'blue', 'green', 'purple'),
domain = data$NIBRSDescription
)
data$Address<-paste( data$StreetNo
,' '
,data$StreetName
,' '
,data$StreetType
,' '
,data$Suffix)
data$popup<-paste("<b>Incident #: </b>", data$Incident, "<br>",
"<br>", "<b>Description: </b>", data$NIBRSDescription,
"<br>", "<b>Date: </b>", data$RMSOccurrenceDate,
"<br>", "<b>Time: </b>", data$RMSOccurrenceHour,
"<br>", "<b>Council District: </b>",data$DISTRICT,
"<br>", "<b>HPD Beat: </b>", data$Beat,
"<br>", "<b>Address: </b>", data$Address,
"<br>", "<b>Longitude: </b>", data$MapLongitude,
"<br>", "<b>Latitude: </b>", data$MapLatitude)
data%>%leaflet()%>%
addTiles()%>%
addTiles(group = "OSM (default)") %>%
addProviderTiles(provider = "Esri.WorldStreetMap",group = "World StreetMap") %>%
addProviderTiles(provider = "Esri.WorldImagery",group = "World Imagery") %>%
# addProviderTiles(provider = "NASAGIBS.ViirsEarthAtNight2012",group = "Nighttime Imagery") %>%
addCircleMarkers( lng = ~MapLongitude
,lat = ~MapLatitude
,popup=data$popup
,clusterOptions=markerClusterOptions()
,color=~pal(NIBRSDescription)) %>%
addLayersControl(
baseGroups = c("OSM (default)","World StreetMap", "World Imagery"),
options = layersControlOptions(collapsed = FALSE))%>%
addPolygons( data=districts
,fill=T
,color="grey"
,opacity=1
,weight=2)
}
geo_plot(datax)
data_pre<-multi_year[  (NIBRSDescription %chin% violent_crimes)
&(RMSOccurrenceDate>='2023-06-01')
,]%>%
.[ (!is.na(MapLongitude))
|(!is.na(MapLatitude))]%>%
st_as_sf( coords=c("MapLongitude","MapLatitude")
,crs=4326
,remove=FALSE)
datax<-st_join( data_pre
,districts
,join = st_within)
geo_plot<-function(data=data){
pal <- colorFactor(
palette = c('orange', 'blue', 'green', 'purple'),
domain = data$NIBRSDescription
)
data$Address<-paste( data$StreetNo
,' '
,data$StreetName
,' '
,data$StreetType
,' '
,data$Suffix)
data$popup<-paste("<b>Incident #: </b>", data$Incident, "<br>",
"<br>", "<b>Description: </b>", data$NIBRSDescription,
"<br>", "<b>Date: </b>", data$RMSOccurrenceDate,
"<br>", "<b>Time: </b>", data$RMSOccurrenceHour,
"<br>", "<b>Council District: </b>",data$DISTRICT,
"<br>", "<b>HPD Beat: </b>", data$Beat,
"<br>", "<b>Address: </b>", data$Address,
"<br>", "<b>Longitude: </b>", data$MapLongitude,
"<br>", "<b>Latitude: </b>", data$MapLatitude)
data%>%leaflet()%>%
addTiles()%>%
addTiles(group = "OSM (default)") %>%
addProviderTiles(provider = "Esri.WorldStreetMap",group = "World StreetMap") %>%
addProviderTiles(provider = "Esri.WorldImagery",group = "World Imagery") %>%
# addProviderTiles(provider = "NASAGIBS.ViirsEarthAtNight2012",group = "Nighttime Imagery") %>%
addCircleMarkers( lng = ~MapLongitude
,lat = ~MapLatitude
,popup=data$popup
,clusterOptions=markerClusterOptions()
,color=~pal(NIBRSDescription)) %>%
addLayersControl(
baseGroups = c("OSM (default)","World StreetMap", "World Imagery"),
options = layersControlOptions(collapsed = FALSE))%>%
addPolygons( data=districts
,fill=T
,color="grey"
,opacity=1
,weight=2)
}
geo_plot(datax)
library("readxl")
library("glue")
library("tidyverse")
library("data.table")
library("zoo")
library("ggplot2")
library("ggthemes")
library("leaflet")
library('sf')
library('dplyr')
setwd('C:/Users/chris/Documents/GitHub/HoustonCrimeDataAnalysis/R')
source('NIBRS_Trendx.R')
source('YTD_NIBRS.R')
source('GEOPLOT.R')
sf_use_s2(FALSE)
eom<-function( month
,year
,base_day='28'){
return(round_date(as.Date(ISOdate( year=year
,month=month
,day=base_day)),'month')-days(1))
}
#m='06'
#y='2019'
#t<-eom(m,y)
#eom(m,y)
#eom('06','2019')
#theme_update(plot.title = element_text(hjust = 0.5))
where_the_data_is<-'C:/Users/chris/Documents/Random_Nextdoor/My_Crime_Analysis - 05.04.23/Group/Data/HPD_NIBRS/'
support_dir<-'C:/Users/chris/Documents/GitHub/HoustonCrimeDataAnalysis/DATA/Support/'
districts<-st_read(glue("{support_dir}COH_ADMINISTRATIVE_BOUNDARY_-_MIL.geojson"))%>%
filter(!is.na(DISTRICT) )
beats<-st_read(glue("{support_dir}COH_POLICE_BEATS.geojson"))
bydim<-'Overall'
group_dims<-c('NIBRSDescription',bydim)
violent_crimes<-c('Aggravated Assault'
,'Forcible rape'
,'Robbery'
,'Murder, non-negligent')
baseline<-read_excel(glue('{where_the_data_is}2019_NIBRSPublicView.Jan1-Dec31.xlsx'))%>%
rename( OffenseCount=`Offense\r\nCount`
,RMSOccurrenceDate=`Occurrence\r\nDate`
,ZIPCode=`ZIP Code`
,StreetType=`Street\r\nType`
,RMSOccurrenceHour=`Occurrence\r\nHour`
,NIBRSClass=`NIBRS\r\nClass`
,StreetNo=`Block Range`)
baseline$MapLongitude<-NA
baseline$MapLatitude<-NA
min(baseline$RMSOccurrenceDate)
max(baseline$RMSOccurrenceDate)
year1<-read_excel(glue('{where_the_data_is}NIBRSPublicView.Jan1-Dec31-2020.xlsx'))%>%
rename( OffenseCount=`Offense\r\nCount`
,RMSOccurrenceDate=`Occurrence\r\nDate`
,ZIPCode=`ZIP Code`
,StreetType=`Street\r\nType`
,RMSOccurrenceHour=`Occurrence\r\nHour`
,NIBRSClass=`NIBRS\r\nClass`
,StreetNo=`Block Range`)
year1$MapLongitude<-NA
year1$MapLatitude<-NA
min(year1$RMSOccurrenceDate)
max(year1$RMSOccurrenceDate)
year2<-read_excel(glue('{where_the_data_is}NIBRSPublicViewDec21.xlsx'))
year2$MapLongitude<-NA
year2$MapLatitude<-NA
min(year2$RMSOccurrenceDate)
max(year2$RMSOccurrenceDate)
year3<-read_excel(glue('{where_the_data_is}NIBRSPublicViewDec22.xlsx'))
min(year3$RMSOccurrenceDate)
max(year3$RMSOccurrenceDate)
year4<-read_excel(glue('{where_the_data_is}NIBRSPublicViewJun23.xlsx'))
min(year4$RMSOccurrenceDate)
max(year4$RMSOccurrenceDate)
multi_year<-rbind(baseline,year1,year2,year3,year4)%>%
mutate(year_mon=floor_date(RMSOccurrenceDate,'month'))
multi_year$year<-year(multi_year$RMSOccurrenceDate)
multi_year$Overall<-'OverAll'
all_desc<-multi_year%>%group_by(NIBRSDescription)%>%summarize(Freq=sum(OffenseCount))
setDT(multi_year)
to_dt_month<-'06'
YTD_VOLUMES<-multi_year[ (NIBRSDescription %chin% violent_crimes),]%>%
.[ ( RMSOccurrenceDate>=glue('2019-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2019))
|( RMSOccurrenceDate>=glue('2020-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2020))
|( RMSOccurrenceDate>=glue('2021-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2021))
|( RMSOccurrenceDate>=glue('2022-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2022))
|( RMSOccurrenceDate>=glue('2023-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2023)),]
ETL_VALIDATE<-function(){
qa_year_mon<-multi_year%>%
group_by(year_mon)%>%
summarize(Row_Count=n())%>%
filter()
qa_year_mon$year_mon<-as.Date(qa_year_mon$year_mon)
str(qa_year_mon)
ggplot( data=qa_year_mon
,aes( x=year_mon
,y=Row_Count))+
geom_bar(stat="identity")+
scale_x_date( breaks = date_breaks("months")
,labels = date_format("%b-%Y")
,expand = c(.01, .01))+
theme(axis.text.x = element_text( angle = 90
,vjust = 0.5
,hjust=1))+
#  Labelling as desired
labs(
title = "Row-Counts By Year-Month"
#,subtitle = "SUB"
#,caption = "Caption"
)
qa_year<-multi_year%>%
group_by(year)%>%
summarize(Row_Count=n())
ggplot( data=qa_year
,aes( x=year
,y=Row_Count))+
geom_bar(stat="identity")
qa_year_by_year_mon<-multi_year%>%group_by(year_mon,year)%>%summarize(freq=n())
to_dt_month<-'06'
YTD_VOLUMES<-multi_year[ (NIBRSDescription %chin% violent_crimes),]%>%
.[ ( RMSOccurrenceDate>=glue('2019-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2019))
|( RMSOccurrenceDate>=glue('2020-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2020))
|( RMSOccurrenceDate>=glue('2021-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2021))
|( RMSOccurrenceDate>=glue('2022-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2022))
|( RMSOccurrenceDate>=glue('2023-01-01')
&RMSOccurrenceDate<=eom(to_dt_month,2023)),]
year_vol<-YTD_VOLUMES%>%group_by(year)%>%summarize(freq=n())
ggplot( data=year_vol
,aes( x=year
,y=freq))+
geom_bar(stat="identity")
}
# install the kohonen package
#install.packages("kohonen")
# load the kohonen package
library("kohonen")
crimes_filtered<-multi_year[NIBRSDescription %chin% violent_crimes]%>%
.[ (RMSOccurrenceDate>='2023-06-01')
&(RMSOccurrenceDate<='2023-06-30')]%>%
.[ (!is.na(MapLongitude))
|(!is.na(MapLatitude))]
coords<-scale(crimes_filtered[,.(MapLongitude,MapLatitude)])
grid<-somgrid( xdim=5
,ydim=5
,topo="hexagonal")
model<-som( coords
,grid=grid
,rlen=100
,alpha=c(0.05,0.01))
names(model)
testa<-as.data.frame(model$codes)
clus_coords<-cbind(as.data.frame(model$unit.classif),coords)
combined<-cbind(crimes_filtered,clus_coords)
names(combined)<-make.names( names(combined)
,unique=TRUE)
centers<-combined%>%group_by(`model.unit.classif`)%>%summarize( MapLongitude=mean(MapLongitude)
,MapLatitude=mean(MapLatitude))
centers%>%leaflet()%>%
addTiles()%>%
addTiles(group = "OSM (default)") %>%
addProviderTiles(provider = "Esri.WorldStreetMap",group = "World StreetMap") %>%
addProviderTiles(provider = "Esri.WorldImagery",group = "World Imagery") %>%
# addProviderTiles(provider = "NASAGIBS.ViirsEarthAtNight2012",group = "Nighttime Imagery") %>%
addCircleMarkers( lng = ~MapLongitude
,lat = ~MapLatitude
,label=~`model.unit.classif`
) %>%
addLayersControl(
baseGroups = c("OSM (default)","World StreetMap", "World Imagery"),
options = layersControlOptions(collapsed = FALSE))%>%
addPolygons( data=districts
,fill=T
,color="grey"
,opacity=1
,weight=2)
#geo_plot(data=centers)
View(combined)
View(combined)
View(combined)
View(combined)
setDT(combined)
combined[,.(Freq=sum(OffenseCount)),by=c('Premise')]
View(combined)
cluster_prem<-combined[,.(Freq=sum(OffenseCount)),by=c('Premise','model.unit.classif')]
View(cluster_prem)
View(cluster_prem)
dcast( cluster_prem
,id ~ model.unit.classif
,value.var = c("OffenseCount"))
dcast( cluster_prem
,id ~ model.unit.classif
,value.var = c("Freq"))
dcast( cluster_prem
,id ~model.unit.classif
,value.var = c("Freq"))
dcast( cluster_prem
,Premise~model.unit.classif
,value.var = c("Freq"))
prem_comp<-dcast( cluster_prem
,Premise~model.unit.classif
,value.var = c("Freq"))
View(prem_comp)
View(prem_comp)
setDT(combined)
cluster_prem<-combined[,.(Freq=sum(OffenseCount)),by=c('Premise','model.unit.classif')]
prem_comp<-dcast( cluster_prem
,Premise~model.unit.classif
,value.var = c("Freq"))
cluster_desc<-combined[,.(Freq=sum(OffenseCount)),by=c('NIBRSDescription','model.unit.classif')]
desc_comp<-dcast( cluster_desc
,Premise~model.unit.classif
,value.var = c("Freq"))
setDT(combined)
cluster_prem<-combined[,.(Freq=sum(OffenseCount)),by=c('Premise','model.unit.classif')]
prem_comp<-dcast( cluster_prem
,Premise~model.unit.classif
,value.var = c("Freq"))
cluster_desc<-combined[,.(Freq=sum(OffenseCount)),by=c('NIBRSDescription','model.unit.classif')]
desc_comp<-dcast( cluster_desc
,NIBRSDescription~model.unit.classif
,value.var = c("Freq"))
View(desc_comp)
View(desc_comp)
incident_clus<-combined[,.(Freq=sum(OffenseCount)),by=c('model.unit.classif')]
View(incident_clus)
View(incident_clus)
View(incident_clus)
View(incident_clus)
# install the kohonen package
#install.packages("kohonen")
# load the kohonen package
library("kohonen")
crimes_filtered<-multi_year[NIBRSDescription %chin% violent_crimes]%>%
.[ (RMSOccurrenceDate>='2023-06-01')
&(RMSOccurrenceDate<='2023-06-30')]%>%
.[ (!is.na(MapLongitude))
|(!is.na(MapLatitude))]
coords<-scale(crimes_filtered[,.(MapLongitude,MapLatitude)])
grid<-somgrid( xdim=4
,ydim=4
,topo="hexagonal")
model<-som( coords
,grid=grid
,rlen=100
,alpha=c(0.05,0.01))
names(model)
testa<-as.data.frame(model$codes)
clus_coords<-cbind(as.data.frame(model$unit.classif),coords)
combined<-cbind(crimes_filtered,clus_coords)
names(combined)<-make.names( names(combined)
,unique=TRUE)
centers<-combined%>%group_by(`model.unit.classif`)%>%summarize( MapLongitude=mean(MapLongitude)
,MapLatitude=mean(MapLatitude))
centers%>%leaflet()%>%
addTiles()%>%
addTiles(group = "OSM (default)") %>%
addProviderTiles(provider = "Esri.WorldStreetMap",group = "World StreetMap") %>%
addProviderTiles(provider = "Esri.WorldImagery",group = "World Imagery") %>%
# addProviderTiles(provider = "NASAGIBS.ViirsEarthAtNight2012",group = "Nighttime Imagery") %>%
addCircleMarkers( lng = ~MapLongitude
,lat = ~MapLatitude
,label=~`model.unit.classif`
) %>%
addLayersControl(
baseGroups = c("OSM (default)","World StreetMap", "World Imagery"),
options = layersControlOptions(collapsed = FALSE))%>%
addPolygons( data=districts
,fill=T
,color="grey"
,opacity=1
,weight=2)
#geo_plot(data=centers)
setDT(combined)
incident_clus<-combined[,.(Freq=sum(OffenseCount)),by=c('model.unit.classif')]
cluster_prem<-combined[,.(Freq=sum(OffenseCount)),by=c('Premise','model.unit.classif')]
prem_comp<-dcast( cluster_prem
,Premise~model.unit.classif
,value.var = c("Freq"))
cluster_desc<-combined[,.(Freq=sum(OffenseCount)),by=c('NIBRSDescription','model.unit.classif')]
desc_comp<-dcast( cluster_desc
,NIBRSDescription~model.unit.classif
,value.var = c("Freq"))
View(incident_clus)
View(incident_clus)
# install the kohonen package
#install.packages("kohonen")
# load the kohonen package
library("kohonen")
crimes_filtered<-multi_year[NIBRSDescription %chin% violent_crimes]%>%
.[ (RMSOccurrenceDate>='2023-06-01')
&(RMSOccurrenceDate<='2023-06-30')]%>%
.[ (!is.na(MapLongitude))
|(!is.na(MapLatitude))]
coords<-scale(crimes_filtered[,.(MapLongitude,MapLatitude)])
grid<-somgrid( xdim=4
,ydim=4
,topo="hexagonal")
model<-som( coords
,grid=grid
,rlen=100
,alpha=c(0.05,0.01))
names(model)
testa<-as.data.frame(model$codes)
clus_coords<-cbind(as.data.frame(model$unit.classif),coords)
combined<-cbind(crimes_filtered,clus_coords)
names(combined)<-make.names( names(combined)
,unique=TRUE)
centers<-combined%>%group_by(`model.unit.classif`)%>%summarize( MapLongitude=mean(MapLongitude)
,MapLatitude=mean(MapLatitude))
centers%>%leaflet()%>%
addTiles()%>%
addTiles(group = "OSM (default)") %>%
addProviderTiles(provider = "Esri.WorldStreetMap",group = "World StreetMap") %>%
addProviderTiles(provider = "Esri.WorldImagery",group = "World Imagery") %>%
# addProviderTiles(provider = "NASAGIBS.ViirsEarthAtNight2012",group = "Nighttime Imagery") %>%
addPolygons( data=districts
,fill=T
,color="grey"
,opacity=1
,weight=2)%>%
addCircleMarkers( lng = ~MapLongitude
,lat = ~MapLatitude
,label=~`model.unit.classif`
) %>%
addLayersControl(
baseGroups = c("OSM (default)","World StreetMap", "World Imagery"),
options = layersControlOptions(collapsed = FALSE))
#geo_plot(data=centers)
setDT(combined)
incident_clus<-combined[,.(Freq=sum(OffenseCount)),by=c('model.unit.classif')]
cluster_prem<-combined[,.(Freq=sum(OffenseCount)),by=c('Premise','model.unit.classif')]
prem_comp<-dcast( cluster_prem
,Premise~model.unit.classif
,value.var = c("Freq"))
cluster_desc<-combined[,.(Freq=sum(OffenseCount)),by=c('NIBRSDescription','model.unit.classif')]
desc_comp<-dcast( cluster_desc
,NIBRSDescription~model.unit.classif
,value.var = c("Freq"))
View(incident_clus)
View(incident_clus)
# install the kohonen package
#install.packages("kohonen")
# load the kohonen package
library("kohonen")
crimes_filtered<-multi_year[NIBRSDescription %chin% violent_crimes]%>%
.[ (RMSOccurrenceDate>='2023-06-01')
&(RMSOccurrenceDate<='2023-06-30')]%>%
.[ (!is.na(MapLongitude))
|(!is.na(MapLatitude))]
coords<-scale(crimes_filtered[,.(MapLongitude,MapLatitude)])
grid<-somgrid( xdim=4
,ydim=4
,topo="hexagonal")
model<-som( coords
,grid=grid
,rlen=100
,alpha=c(0.05,0.01))
names(model)
testa<-as.data.frame(model$codes)
clus_coords<-cbind(as.data.frame(model$unit.classif),coords)
combined<-cbind(crimes_filtered,clus_coords)
names(combined)<-make.names( names(combined)
,unique=TRUE)
centers<-combined%>%group_by(`model.unit.classif`)%>%summarize( MapLongitude=mean(MapLongitude)
,MapLatitude=mean(MapLatitude))
centers%>%leaflet()%>%
addTiles()%>%
addTiles(group = "OSM (default)") %>%
addProviderTiles(provider = "Esri.WorldStreetMap",group = "World StreetMap") %>%
addProviderTiles(provider = "Esri.WorldImagery",group = "World Imagery") %>%
# addProviderTiles(provider = "NASAGIBS.ViirsEarthAtNight2012",group = "Nighttime Imagery") %>%
addPolygons( data=districts
,fill=T
,color="grey"
,opacity=1
,weight=2)%>%
addMarkers( lng = ~MapLongitude
,lat = ~MapLatitude
,label=~`model.unit.classif`
) %>%
addLayersControl(
baseGroups = c("OSM (default)","World StreetMap", "World Imagery"),
options = layersControlOptions(collapsed = FALSE))
#geo_plot(data=centers)
